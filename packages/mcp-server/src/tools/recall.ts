import type { ToolWithHandler } from '~/interfaces/MCPServer.js';
import { MCPOutputAdapter } from '~/utils/MCPOutputAdapter.js';

const outputAdapter = new MCPOutputAdapter();

export const recallTool: ToolWithHandler = {
  name: 'recall',
  description: `ã€è®¤çŸ¥ä¹ æƒ¯ã€‘åŸºäºè®°å¿†ç½‘ç»œçš„è¯­ä¹‰åœºæ¿€æ´»

ã€è§„èŒƒåç§°ã€‘promptx_recall
ã€è°ƒç”¨è¯´æ˜ã€‘åœ¨æç¤ºè¯ä¸­ä½¿ç”¨ promptx_recallï¼Œå®é™…è°ƒç”¨æ—¶è‡ªåŠ¨æ˜ å°„åˆ° mcp__[server]__recall

âš¡ ä¸‰ç§ä½¿ç”¨æ¨¡å¼ï¼š

**1. DMNæ¨¡å¼ï¼ˆDefault Mode Networkï¼‰- é¦–æ¬¡æ¢ç´¢æ¨è**
- ç”¨æ³•ï¼šä¸ä¼ queryå‚æ•° recall(role)
- æ•ˆæœï¼šè‡ªåŠ¨é€‰æ‹©5ä¸ªæ¢çº½èŠ‚ç‚¹(è¿æ¥åº¦æœ€é«˜)ï¼Œå¤šä¸­å¿ƒæ¿€æ´»
- åœºæ™¯ï¼šé¦–æ¬¡æ¢ç´¢è®°å¿†ç½‘ç»œã€ä¸çŸ¥é“æœ‰å“ªäº›å…³é”®è¯ã€æ­»èƒ¡åŒé‡ç½®
- åŸç†ï¼šæ¨¡æ‹Ÿäººè„‘é»˜è®¤ç½‘ç»œçš„è‡ªå‘æ¿€æ´»ï¼Œå±•ç¤ºæ ¸å¿ƒè®°å¿†ç»“æ„

**2. å•è¯recall - ç²¾ç¡®æ£€ç´¢**
- ç”¨æ³•ï¼šä¼ å…¥å•ä¸ªå…³é”®è¯ recall(role, "PromptX")
- æ•ˆæœï¼šä»è¯¥è¯å¼€å§‹æ¿€æ´»æ‰©æ•£ï¼ŒæŸ¥æ‰¾ç›¸å…³è®°å¿†
- åœºæ™¯ï¼šå·²çŸ¥å…³é”®è¯ï¼Œæƒ³æ·±å…¥æ¢ç´¢ç›¸å…³å†…å®¹

**3. å¤šè¯recall - äº¤å‰æ¢ç´¢**
- ç”¨æ³•ï¼šç©ºæ ¼åˆ†éš”å¤šä¸ªè¯ recall(role, "PromptX æµ‹è¯• ä¿®å¤")
- æ•ˆæœï¼šåˆ›å»ºè™šæ‹Ÿ"mind"æ ¹èŠ‚ç‚¹ï¼Œå¤šè¯åŒæ—¶æ¿€æ´»ï¼Œèƒ½é‡å‡åˆ†
- åœºæ™¯ï¼šæ¢ç´¢å¤šä¸ªæ¦‚å¿µçš„äº¤é›†ã€è·¨åŸŸè”æƒ³

ğŸ§  å¼ºåˆ¶æ€§é€‰è¯è§„åˆ™ï¼ˆå•è¯/å¤šè¯æ¨¡å¼é€‚ç”¨ï¼‰ï¼š

**é“å¾‹ï¼šåªèƒ½ä½¿ç”¨è®°å¿†ç½‘ç»œå›¾ä¸­å®é™…å­˜åœ¨çš„è¯**

é€‰è¯æµç¨‹ï¼š
1ï¸âƒ£ å…ˆç”¨actionæˆ–DMNæ¨¡å¼æŸ¥çœ‹ç½‘ç»œå›¾ï¼Œäº†è§£æœ‰å“ªäº›å…³é”®è¯
2ï¸âƒ£ ä»ç½‘ç»œå›¾ä¸­é€‰æ‹©å­˜åœ¨çš„è¯ï¼ˆç²¾ç¡®åŒ¹é…æˆ–å­ä¸²åŒ¹é…ï¼‰
3ï¸âƒ£ å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…è¯ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·å¤±è´¥ï¼Œå»ºè®®ä»ç½‘ç»œå›¾ä¸­é€‰æ‹©

é€‰è¯è§„åˆ™ï¼š
â€¢ âœ… ç²¾ç¡®åŒ¹é…ï¼šç½‘ç»œå›¾ä¸­æœ‰è¯¥è¯ â†’ ç›´æ¥ä½¿ç”¨
â€¢ âœ… å­ä¸²åŒ¹é…ï¼šç½‘ç»œå›¾ä¸­çš„è¯åŒ…å«æŸ¥è¯¢è¯ â†’ ä½¿ç”¨ç½‘ç»œå›¾çš„è¯
â€¢ âŒ è¯­ä¹‰ç›¸è¿‘ï¼š**ç¦æ­¢**æ¨æµ‹ç›¸è¿‘è¯
â€¢ âŒ æ¦‚å¿µæŠ½è±¡ï¼š**ç¦æ­¢**è‡ªè¡ŒæŠ½è±¡æˆ–è½¬æ¢

ğŸ¯ è®¤çŸ¥æ¿€æ´»æ¨¡å¼ï¼ˆå¯é€‰å‚æ•°modeï¼‰ï¼š

- **creative**: åˆ›é€ æ€§æ¢ç´¢ - ä½é˜ˆå€¼(0.05)ã€å¹¿æ³›è”æƒ³ã€è¿œè·ç¦»è¿æ¥
- **balanced**: å¹³è¡¡æ¨¡å¼ - ä¸­é˜ˆå€¼(0.1)ã€ç³»ç»Ÿé»˜è®¤
- **focused**: èšç„¦æ£€ç´¢ - é«˜é˜ˆå€¼(0.2)ã€ç²¾ç¡®æŸ¥æ‰¾ã€å¸¸ç”¨è®°å¿†ä¼˜å…ˆ

ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼š

â€¢ è®°å¿†æ£€ç´¢å¿…é¡»åŸºäº**ç¼–ç æ—¶å»ºç«‹çš„çº¿ç´¢**
â€¢ äººè„‘ä¹Ÿæ— æ³•ç”¨"ä»æœªå»ºç«‹å…³è”çš„çº¿ç´¢"å›å¿†
â€¢ è¿™æ˜¯è®¤çŸ¥ç³»ç»Ÿçš„æ ¸å¿ƒçº¦æŸï¼Œä¸æ˜¯bugè€Œæ˜¯feature
â€¢ å¼ºåˆ¶ç†è§£"è®°å¿†æ˜¯ç½‘ç»œï¼Œä¸æ˜¯å…¨æ–‡æœç´¢"

ğŸ“ å®é™…å·¥ä½œæµç¨‹ç¤ºä¾‹ï¼š

**é¦–æ¬¡æ¢ç´¢**ï¼š
  1. recall(sean)  // DMNæ¨¡å¼ï¼Œè‡ªåŠ¨æ¿€æ´»5ä¸ªæ¢çº½èŠ‚ç‚¹
  2. æŸ¥çœ‹è¿”å›çš„å…³é”®è¯ç½‘ç»œ
  3. é€‰æ‹©æ„Ÿå…´è¶£çš„è¯ç»§ç»­æ¢ç´¢

**ç²¾ç¡®æ£€ç´¢**ï¼š
  recall(sean, "PromptX")  // å•è¯æ¨¡å¼ï¼Œæ·±å…¥æ¢ç´¢PromptXç›¸å…³è®°å¿†

**äº¤å‰æ¢ç´¢**ï¼š
  recall(sean, "DMN æµ‹è¯• ä¿®å¤")  // å¤šè¯æ¨¡å¼ï¼Œæ¢ç´¢ä¸‰ä¸ªæ¦‚å¿µçš„äº¤é›†

**åˆ›é€ æ€§æ¢ç´¢**ï¼š
  recall(sean, "æ¿€æ´»æ‰©æ•£", { mode: "creative" })  // å¹¿æ³›è”æƒ³ï¼Œå‘ç°è¿œè·ç¦»è¿æ¥

è®°ä½ï¼šè®°å¿†ç½‘ç»œæ˜¯è®¤çŸ¥åœ°å›¾ï¼Œä»å·²æœ‰çš„ç‚¹å¼€å§‹æ¢ç´¢ï¼`,
  inputSchema: {
    type: 'object',
    properties: {
      role: {
        type: 'string',
        description: 'è¦æ£€ç´¢è®°å¿†çš„è§’è‰²IDï¼Œå¦‚ï¼šjava-developer, product-manager, copywriter'
      },
      query: {
        oneOf: [
          { type: 'string' },
          { type: 'null' }
        ],
        description: 'æ£€ç´¢å…³é”®è¯ï¼šå•è¯æˆ–ç©ºæ ¼åˆ†éš”çš„å¤šè¯(string)ã€æˆ–null(DMNæ¨¡å¼,è‡ªåŠ¨é€‰æ‹©æ¢çº½èŠ‚ç‚¹)ã€‚å¤šè¯ç¤ºä¾‹ï¼š"PromptX æµ‹è¯• ä¿®å¤"ã€‚å¿…é¡»ä½¿ç”¨è®°å¿†ç½‘ç»œå›¾ä¸­å®é™…å­˜åœ¨çš„è¯ã€‚'
      },
      mode: {
        type: 'string',
        enum: ['creative', 'balanced', 'focused'],
        description: 'è®¤çŸ¥æ¿€æ´»æ¨¡å¼ï¼šcreative(åˆ›é€ æ€§æ¢ç´¢ï¼Œå¹¿æ³›è”æƒ³)ã€balanced(å¹³è¡¡æ¨¡å¼ï¼Œé»˜è®¤)ã€focused(èšç„¦æ£€ç´¢ï¼Œç²¾ç¡®æŸ¥æ‰¾)'
      }
    },
    required: ['role']
  },
  handler: async (args: { role: string; query?: string | null; mode?: string }) => {
    const core = await import('@promptx/core');
    const coreExports = core.default || core;
    const cli = (coreExports as any).cli || (coreExports as any).pouch?.cli;

    if (!cli || !cli.execute) {
      throw new Error('CLI not available in @promptx/core');
    }

    // æ„å»º CLI å‚æ•°ï¼Œæ”¯æŒ string | string[] | null
    const cliArgs: any[] = [{
      role: args.role,
      query: args.query ?? null,  // undefinedè½¬ä¸ºnull
      mode: args.mode
    }];

    const result = await cli.execute('recall', cliArgs);
    return outputAdapter.convertToMCPFormat(result);
  }
};