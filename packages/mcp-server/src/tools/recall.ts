import type { ToolWithHandler } from '~/interfaces/MCPServer.js';
import { MCPOutputAdapter } from '~/utils/MCPOutputAdapter.js';

const outputAdapter = new MCPOutputAdapter();

export const recallTool: ToolWithHandler = {
  name: 'recall',
  description: `ã€è®¤çŸ¥ä¹ æƒ¯ã€‘åŸºäºè®°å¿†ç½‘ç»œçš„è¯­ä¹‰åœºæ¿€æ´»

ã€è§„èŒƒåç§°ã€‘promptx_recall
ã€è°ƒç”¨è¯´æ˜ã€‘åœ¨æç¤ºè¯ä¸­ä½¿ç”¨ promptx_recallï¼Œå®é™…è°ƒç”¨æ—¶è‡ªåŠ¨æ˜ å°„åˆ° mcp__[server]__recall

âš¡ è§¦å‘æ—¶æœºï¼ˆå½¢æˆæ¡ä»¶åå°„ï¼‰ï¼š
çœ‹åˆ°ç”¨æˆ·é—®é¢˜ â†’ æŸ¥çœ‹è®°å¿†ç½‘ç»œå›¾ â†’ é€‰æ‹©å·²å­˜åœ¨çš„è¯ â†’ æ¿€æ´»æ‰©æ•£

ğŸ§  å¼ºåˆ¶æ€§é€‰è¯è§„åˆ™ï¼ˆä¸å¯è¿åï¼‰ï¼š

**é“å¾‹ï¼šåªèƒ½ä½¿ç”¨è®°å¿†ç½‘ç»œå›¾ä¸­å®é™…å­˜åœ¨çš„è¯**

ç¬¬1æ­¥ - å…ˆæ¿€æ´»è§’è‰²è·å–ç½‘ç»œå›¾ï¼š
â€¢ ä½¿ç”¨ action å·¥å…·æŸ¥çœ‹å½“å‰è§’è‰²çš„è®°å¿†ç½‘ç»œå›¾
â€¢ ç½‘ç»œå›¾å±•ç¤ºæ‰€æœ‰å¯ç”¨çš„å…³é”®è¯èŠ‚ç‚¹
â€¢ è¿™æ˜¯ä½ å”¯ä¸€çš„"è¯æ±‡è¡¨"

ç¬¬2æ­¥ - ä»ç½‘ç»œå›¾ä¸­é€‰è¯ï¼ˆä¸¥æ ¼åŒ¹é…ï¼‰ï¼š
â€¢ âœ… ç²¾ç¡®åŒ¹é…ï¼šé—®é¢˜åŒ…å«ç½‘ç»œå›¾ä¸­çš„æŸä¸ªè¯ â†’ ç›´æ¥ä½¿ç”¨
â€¢ âœ… è¯çš„ä¸€éƒ¨åˆ†ï¼šç½‘ç»œå›¾ä¸­çš„è¯æ˜¯é—®é¢˜è¯çš„å­ä¸² â†’ ä½¿ç”¨ç½‘ç»œå›¾ä¸­çš„è¯
â€¢ âŒ è¯­ä¹‰ç›¸è¿‘ï¼š**ç¦æ­¢**æ¨æµ‹ç›¸è¿‘è¯ï¼Œå¿…é¡»ä½¿ç”¨ç½‘ç»œå›¾å®é™…å­˜åœ¨çš„è¯
â€¢ âŒ æ¦‚å¿µæŠ½è±¡ï¼š**ç¦æ­¢**è‡ªè¡ŒæŠ½è±¡ï¼Œåªèƒ½ç”¨ç½‘ç»œå›¾å·²æœ‰çš„è¯

ç¬¬3æ­¥ - å¦‚æœæ‰¾ä¸åˆ°åŒ¹é…ï¼š
â€¢ **ä¸è¦çŒœæµ‹**ï¼Œä¸è¦å°è¯•recall
â€¢ ç›´æ¥å‘ŠçŸ¥ç”¨æˆ·ï¼šè¯¥å…³é”®è¯ä¸åœ¨è®°å¿†ç½‘ç»œä¸­
â€¢ å»ºè®®ç”¨æˆ·æŸ¥çœ‹ action è¿”å›çš„ç½‘ç»œå›¾ï¼Œä»ä¸­é€‰æ‹©

ç¬¬4æ­¥ - è¯­ä¹‰åœºæ¿€æ´»ï¼š
â€¢ ä»é€‰å®šçš„è¯å¼€å§‹æ¿€æ´»
â€¢ è®©æ¿€æ´»è‡ªç„¶æ‰©æ•£åˆ°ç›¸å…³è®°å¿†
â€¢ å¤šä¸ªå…¥å£ç‚¹å¯å¹¶è¡Œæ¿€æ´»

ğŸ”¥ **NEW: å¤šè¯recallä¸DMNæ¨¡å¼**

**å¤šè¯recall**ï¼šåŒæ—¶ä»å¤šä¸ªå…³é”®è¯æ¿€æ´»
- ç”¨æ³•ï¼šqueryç”¨ç©ºæ ¼åˆ†éš”å¤šä¸ªè¯ "è¯1 è¯2 è¯3"
- æ•ˆæœï¼šåˆ›å»ºè™šæ‹Ÿ"mind"æ ¹èŠ‚ç‚¹ï¼Œæ‰€æœ‰è¾“å…¥è¯ä½œä¸ºç¬¬ä¸€å±‚å­èŠ‚ç‚¹
- èƒ½é‡ï¼šå‡åˆ†åˆå§‹èƒ½é‡(1.0 / è¯æ•°)

**DMNæ¨¡å¼**ï¼ˆDefault Mode Networkï¼‰ï¼šæ— çº¿ç´¢çš„å…¨å±€æ¿€æ´»
- ç”¨æ³•ï¼šqueryä¼ å…¥nullæˆ–ä¸ä¼ 
- æ•ˆæœï¼šè‡ªåŠ¨é€‰æ‹©5ä¸ªæ¢çº½èŠ‚ç‚¹(è¿æ¥åº¦æœ€é«˜çš„èŠ‚ç‚¹)
- åœºæ™¯ï¼šé¦–æ¬¡æ¢ç´¢ã€æ­»èƒ¡åŒé‡ç½®ã€å®šæœŸå›é¡¾

æ ¸å¿ƒåŸåˆ™ï¼š
âœ… å¿…é¡»ä½¿ç”¨è®°å¿†ç½‘ç»œå›¾ä¸­å®é™…å­˜åœ¨çš„è¯
âœ… å…ˆç”¨ action æŸ¥çœ‹ç½‘ç»œå›¾ï¼Œå†å†³å®šç”¨ä»€ä¹ˆè¯
âœ… æ‰¾ä¸åˆ°åŒ¹é…è¯æ—¶ï¼Œæ˜ç¡®å‘ŠçŸ¥å¤±è´¥
âŒ ç»ä¸çŒœæµ‹ã€æ¨æµ‹ã€æŠ½è±¡ç½‘ç»œå›¾ä¹‹å¤–çš„è¯
âŒ ä¸è¦"å¸®ç”¨æˆ·"æŠŠä¸å­˜åœ¨çš„è¯è½¬æ¢æˆå­˜åœ¨çš„è¯

ä¸ºä»€ä¹ˆè¿™æ ·ä¸¥æ ¼ï¼š
â€¢ è®°å¿†æ£€ç´¢å¿…é¡»åŸºäº**ç¼–ç æ—¶å»ºç«‹çš„çº¿ç´¢**
â€¢ äººè„‘ä¹Ÿæ— æ³•ç”¨"ä»æœªå»ºç«‹å…³è”çš„çº¿ç´¢"å›å¿†
â€¢ è¿™æ˜¯è®¤çŸ¥ç³»ç»Ÿçš„æ ¸å¿ƒçº¦æŸï¼Œä¸æ˜¯bugè€Œæ˜¯feature
â€¢ å¼ºåˆ¶ç”¨æˆ·ç†è§£"è®°å¿†æ˜¯ç½‘ç»œï¼Œä¸æ˜¯å…¨æ–‡æœç´¢"

å®é™…å·¥ä½œæµç¨‹ç¤ºä¾‹ï¼š
1. å•è¯recallï¼šquery="PromptX"
2. å¤šè¯recallï¼šquery="PromptX æµ‹è¯• ä¿®å¤"
3. DMNæ¨¡å¼ï¼šquery=null (è‡ªåŠ¨é€‰æ‹©æ¢çº½èŠ‚ç‚¹)

è®°ä½ï¼šè®°å¿†ç½‘ç»œæ˜¯è®¤çŸ¥åœ°å›¾ï¼Œåªèƒ½ä»åœ°å›¾ä¸Š**å·²æœ‰çš„ç‚¹**å¼€å§‹æ¢ç´¢ï¼`,
  inputSchema: {
    type: 'object',
    properties: {
      role: {
        type: 'string',
        description: 'è¦æ£€ç´¢è®°å¿†çš„è§’è‰²IDï¼Œå¦‚ï¼šjava-developer, product-manager, copywriter'
      },
      query: {
        oneOf: [
          { type: 'string' },
          { type: 'null' }
        ],
        description: 'æ£€ç´¢å…³é”®è¯ï¼šå•è¯æˆ–ç©ºæ ¼åˆ†éš”çš„å¤šè¯(string)ã€æˆ–null(DMNæ¨¡å¼,è‡ªåŠ¨é€‰æ‹©æ¢çº½èŠ‚ç‚¹)ã€‚å¤šè¯ç¤ºä¾‹ï¼š"PromptX æµ‹è¯• ä¿®å¤"ã€‚å¿…é¡»ä½¿ç”¨è®°å¿†ç½‘ç»œå›¾ä¸­å®é™…å­˜åœ¨çš„è¯ã€‚'
      },
      mode: {
        type: 'string',
        enum: ['creative', 'balanced', 'focused'],
        description: 'è®¤çŸ¥æ¿€æ´»æ¨¡å¼ï¼šcreative(åˆ›é€ æ€§æ¢ç´¢ï¼Œå¹¿æ³›è”æƒ³)ã€balanced(å¹³è¡¡æ¨¡å¼ï¼Œé»˜è®¤)ã€focused(èšç„¦æ£€ç´¢ï¼Œç²¾ç¡®æŸ¥æ‰¾)'
      }
    },
    required: ['role']
  },
  handler: async (args: { role: string; query?: string | null; mode?: string }) => {
    const core = await import('@promptx/core');
    const coreExports = core.default || core;
    const cli = (coreExports as any).cli || (coreExports as any).pouch?.cli;

    if (!cli || !cli.execute) {
      throw new Error('CLI not available in @promptx/core');
    }

    // æ„å»º CLI å‚æ•°ï¼Œæ”¯æŒ string | string[] | null
    const cliArgs: any[] = [{
      role: args.role,
      query: args.query ?? null,  // undefinedè½¬ä¸ºnull
      mode: args.mode
    }];

    const result = await cli.execute('recall', cliArgs);
    return outputAdapter.convertToMCPFormat(result);
  }
};